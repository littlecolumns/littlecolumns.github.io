<!doctype html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <title>03 - Find car data from VINs</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
  <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Raleway:400,700|Open+Sans:400,700&display=swap" rel="stylesheet"> -->
  <link rel="stylesheet" href="/ds4j/css/spectre.min.css">
  <link rel="stylesheet" href="/ds4j/css/spectre-exp.min.css">
  <link rel="stylesheet" href="/ds4j/css/spectre-icons.min.css">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/ds4j/css/style.css" rel="stylesheet">
  <link href="/ds4j/css/highlight.css" rel="stylesheet">
</head>

<body>
  <div class="nav-holder bg-secondary">
  <div class='content'>
    <header class="navbar">
      <section class="navbar-section">
        <a href="/ds4j/" class="navbar-brand mr-2">DS4J</a>
      </section>
      <section class="navbar-section">
        <a href="/ds4j/projects" class="btn btn-link">Projects</a>
        <a href="/ds4j/topics" class="btn btn-link">Topics</a>
        <a href="/ds4j/curriculum" class="btn btn-link">Curriculum</a>
        <a href="/ds4j/about" class="btn btn-link">About</a>
      </section>
    </header>
  </div>
</div>
  
<div class="content text-based">
  <div class="columns">
    <div class="column col-12 notebook">
      <ul class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="#">Projects</a>
        </li>
        <li class="breadcrumb-item">
          <a href="/ds4j/car-crashes-weight-regression/">Analyzing whether larger cars cause more deadly crashes</a>
        </li>
        <li class="breadcrumb-item">
          <a href="/ds4j/car-crashes-weight-regression/03-find-car-data-from-vins">03 - Find car data from VINs</a>
        </li>
      </ul>

      <div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Tracking-down-car-information-using-VINs">Tracking down car information using VINs<a class="anchor-link" href="#Tracking-down-car-information-using-VINs">#</a></h1><p>While our dataset suppsedly includes the make, model and year of the cars, human-entered data can easily be full of typos and other flaws. By using a car's unique VIN identifier, though, we can use a government database to easily track down a car's make, model and year.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p class="reading-options">
  <a class="btn" href="/ds4j/car-crashes-weight-regression/03-find-car-data-from-vins">
    <i class="fa fa-sm fa-book"></i>
    Read online
  </a>
  <a class="btn" href="/ds4j/car-crashes-weight-regression/notebooks/03 - Find car data from VINs.ipynb">
    <i class="fa fa-sm fa-download"></i>
    Download notebook
  </a>
  <a class="btn" href="#">
    <i class="fa fa-sm fa-laptop"></i>
    Interactive version
  </a>
</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># You can&#39;t use make/model because it&#39;s really dirty, </span>
<span class="c1"># so we take the VIN then use that to look up make/model/year</span>
<span class="c1"># we&#39;ll keep them around to test, though!</span>
<span class="n">vehicles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;combined-vehicle-data.csv&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;VIN_NO&#39;</span><span class="p">,</span> <span class="s1">&#39;VEH_MAKE&#39;</span><span class="p">,</span> <span class="s1">&#39;VEH_MODEL&#39;</span><span class="p">,</span> <span class="s1">&#39;VEH_YEAR&#39;</span><span class="p">])</span>
<span class="n">vehicles</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>VEH_MAKE</th>
      <th>VEH_MODEL</th>
      <th>VEH_YEAR</th>
      <th>VIN_NO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CHEVY</td>
      <td>TAHOE</td>
      <td>2005.0</td>
      <td>1GNEK13Q2J285593</td>
    </tr>
    <tr>
      <th>1</th>
      <td>INFI</td>
      <td>4S</td>
      <td>2003.0</td>
      <td>JNKCV51E63M013580</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">all_vins</span> <span class="o">=</span> <span class="n">vehicles</span><span class="o">.</span><span class="n">VIN_NO</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">all_vins</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>641121</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>I tried a LOT of libraries that weren't this API and they were all impossible trash</p>
</blockquote>
<h1 id="Trying-an-API-from-the-gov't">Trying an API from the gov't<a class="anchor-link" href="#Trying-an-API-from-the-gov't">#</a></h1><ul>
<li>URL: <a href="https://vpic.nhtsa.dot.gov/api/Home/Index/LanguageExamples">https://vpic.nhtsa.dot.gov/api/Home/Index/LanguageExamples</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">API_URL</span> <span class="o">=</span> <span class="s1">&#39;https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVINValuesBatch/&#39;</span>

<span class="k">def</span> <span class="nf">fetch_vin_data</span><span class="p">(</span><span class="n">vin_list</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>    
    <span class="n">delimited_vin_list</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vin_list</span><span class="p">)</span>
    <span class="n">post_fields</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">delimited_vin_list</span> <span class="p">}</span>
    <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Querying for&quot;</span><span class="p">,</span> <span class="n">delimited_vin_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">post_fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;Results&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#fetch_vin_data([&#39;JNKCV51E63M013580&#39;, &#39;5TFUY5F1XBX167340&#39;, &#39;2HGFG4A59FH702545&#39;])</span>
<span class="n">fetch_vin_data</span><span class="p">(</span><span class="n">all_vins</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ABS</th>
      <th>ActiveSafetySysNote</th>
      <th>AdaptiveCruiseControl</th>
      <th>AdaptiveDrivingBeam</th>
      <th>AdaptiveHeadlights</th>
      <th>AdditionalErrorText</th>
      <th>AirBagLocCurtain</th>
      <th>AirBagLocFront</th>
      <th>AirBagLocKnee</th>
      <th>AirBagLocSeatCushion</th>
      <th>...</th>
      <th>VIN</th>
      <th>ValveTrainDesign</th>
      <th>VehicleType</th>
      <th>WheelBaseLong</th>
      <th>WheelBaseShort</th>
      <th>WheelBaseType</th>
      <th>WheelSizeFront</th>
      <th>WheelSizeRear</th>
      <th>Wheels</th>
      <th>Windows</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>In the Possible values section, the Numeric va...</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>...</td>
      <td>1GNEK13Q2J285593</td>
      <td></td>
      <td>MULTIPURPOSE PASSENGER VEHICLE (MPV)</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td></td>
      <td></td>
      <td>...</td>
      <td>JNKCV51E63M013580</td>
      <td></td>
      <td>PASSENGER CAR</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>All Rows</td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td></td>
      <td>...</td>
      <td>5TFUY5F1XBX167340</td>
      <td></td>
      <td>TRUCK</td>
      <td></td>
      <td></td>
      <td>Long</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>
<p>3 rows × 146 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">numbers_per_batch</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">start</span> <span class="o">=</span> <span class="mi">70000</span>
<span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_vins</span><span class="p">)</span>

<span class="c1"># Try again with 250 a lot failed</span>

<span class="n">offset</span> <span class="o">=</span> <span class="n">start</span>
<span class="n">error_offsets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">total</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;vin_cache/</span><span class="si">{start}</span><span class="s2">-</span><span class="si">{offset}</span><span class="s2">-</span><span class="si">{total}</span><span class="s2">-</span><span class="si">{numbers_per_batch}</span><span class="s2">.csv&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Querying {offset - start} / {total- start} - batch of </span><span class="si">{numbers_per_batch}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">all_vins</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">numbers_per_batch</span><span class="p">]</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">fetch_vin_data</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Skipping {offset - start} / {total - start} - batch of </span><span class="si">{numbers_per_batch}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">numbers_per_batch</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Skipping 328000 / 571121 - batch of 1000 Querying 641000 / 571121 - batch of 1000 </pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vin_complete</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ABS</th>
      <th>ActiveSafetySysNote</th>
      <th>AdaptiveCruiseControl</th>
      <th>AdaptiveDrivingBeam</th>
      <th>AdaptiveHeadlights</th>
      <th>AdditionalErrorText</th>
      <th>AirBagLocCurtain</th>
      <th>AirBagLocFront</th>
      <th>AirBagLocKnee</th>
      <th>AirBagLocSeatCushion</th>
      <th>...</th>
      <th>VIN</th>
      <th>ValveTrainDesign</th>
      <th>VehicleType</th>
      <th>WheelBaseLong</th>
      <th>WheelBaseShort</th>
      <th>WheelBaseType</th>
      <th>WheelSizeFront</th>
      <th>WheelSizeRear</th>
      <th>Wheels</th>
      <th>Windows</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>In the Possible values section, the Numeric va...</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>...</td>
      <td>1GNEK13Q2J285593</td>
      <td></td>
      <td>MULTIPURPOSE PASSENGER VEHICLE (MPV)</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td></td>
      <td></td>
      <td>...</td>
      <td>JNKCV51E63M013580</td>
      <td></td>
      <td>PASSENGER CAR</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>All Rows</td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td></td>
      <td>...</td>
      <td>5TFUY5F1XBX167340</td>
      <td></td>
      <td>TRUCK</td>
      <td></td>
      <td></td>
      <td>Long</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>1st &amp; 2nd Rows</td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td></td>
      <td></td>
      <td>...</td>
      <td>2HGFG4A59FH702545</td>
      <td>Dual Overhead Cam (DOHC)</td>
      <td>PASSENGER CAR</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>4</th>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>1st &amp; 2nd Rows</td>
      <td>1st Row (Driver &amp; Passenger)</td>
      <td></td>
      <td></td>
      <td>...</td>
      <td>1HGCM66313A037175</td>
      <td>Single Overhead Cam (SOHC)</td>
      <td>PASSENGER CAR</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>
<p>5 rows × 146 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
 


    </div>
  </div>
</div>

<script>
  [...document.querySelectorAll(".code_cell")].filter(cell => cell.innerText.trim().length === 0).forEach(cell => cell.remove())
</script>

  <div class="footer bg-secondary">
  <div class="content">
    <div class="columns">
      <div class="column col-6 col-sm-12">
        <p><strong>Hi, welcome to Data Science for Journalism!</strong></p>
        <p>There's been a lot of buzz about machine learning and "artificial intelligence" being used in stories over
          the past few years. It's mostly not that complicated - a little stats, a classifier here or there - but it's
          hard to know where to start without a little help.</p>
        <p>Hopefully this site can be that help! <a href="/ds4j/about">Learn more about this project here.</a></p>
      </div>
      <div class="column col-3 col-sm-6">
        <p><strong>Quick links</strong></p>
        <!-- <p><a href="#">Something here</a></p>
        <p><a href="#">Something here</a></p>
        <p><a href="#">Something here</a></p> -->
      </div>
      <div class="column col-3 col-sm6">
        <p><strong>Contact</strong></p>
        <p><a href="mailto:hello@littlecolumns.com">hello@littlecolumns.com</a></p>
      </div>
    </div>
  </div>
</div>
  <script src="/ds4j/js/tocbot.js"></script>

  <script>
    try {
      let toc = document.createElement("div")
      toc.setAttribute('class', 'js-toc')
      document.querySelector(".reading-options").parentNode.appendChild(toc)
    } catch (err) {

    }

    tocbot.init({
      // Where to render the table of contents.
      tocSelector: '.js-toc',
      // Where to grab the headings to build the table of contents.
      contentSelector: '.notebook',
      // Which headings to grab inside of the contentSelector element.
      headingSelector: 'h1, h2, h3, h4',
      activeLinkClass: 'active',
      listClass: 'nav',
      listItemClass: 'nav-item',
      headingLabelCallback: function (label) {
        return label.replace("#", "")
      }
    });
  </script>

</body>

</html>